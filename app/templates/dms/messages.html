{% extends 'dms/base_messages.html' %}

{% block head %}

<style>
    /* Hide the default 'x' icon on input[type="search"] */
    input[type="search"]::-webkit-search-cancel-button {
        display: none;
    }
  
    input[type="search"]::-ms-clear {
        display: none;
    }
  
    input[type="search"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    /* Enhanced Message Styles */
    .message {
        max-width: 75%;
        margin: 8px 0;
    }

    .message.sent {
        margin-left: auto;
        text-align: right;
    }

    .message.received {
        margin-right: auto;
    }

    .message-content {
        display: inline-block;
        padding: 12px 16px !important;
        border-radius: 18px !important;
        word-break: break-word;
    }

    .message.sent .message-content {
        background-color: #0d6efd;
        color: white;
        border-top-right-radius: 4px !important;
    }

    .message.received .message-content {
        background-color: #f0f2f5;
        color: #1d2939;
        border-top-left-radius: 4px !important;
    }

    /* Enhanced Card Styles */
    .card {
        border: none;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border-radius: 12px !important;
    }

    .card-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 16px;
        background-color: white !important;
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
    }

    /* Conversations List Styling */
    .list-group-item {
        border: none;
        padding: 16px;
        transition: all 0.2s ease;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .list-group-item.active {
        background-color: #e7f1ff;
        color: #0d6efd;
        border: none;
    }

    /* Message Area Styling */
    #messageArea {
        background-color: #ffffff;
        height: 60vh !important;
        padding: 20px;
    }

    /* Input Area Styling */
    .card-footer {
        background-color: white;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        padding: 16px;
    }

    .input-group {
        background-color: #f0f2f5;
        border-radius: 24px;
        padding: 4px;
    }

    .input-group .form-control {
        border: none;
        background: transparent;
        padding: 12px 16px;
        border-radius: 24px !important;
    }

    .input-group .form-control:focus {
        box-shadow: none;
        background: white;
    }

    .input-group .btn {
        border-radius: 50% !important;
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Modal Styling */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 16px 24px;
    }

    .search-container {
        margin: 16px 0;
    }

    .search-container .form-control {
        border-radius: 24px;
        padding: 12px 20px;
        padding-right: 40px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .search-container .fa-search {
        color: #6c757d;
    }

    /* Header Section Styling */
    .container .btn-primary {
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
    }

    /* Timestamp Styling */
    .text-muted {
        font-size: 0.75rem;
        margin-top: 4px;
    }

    /* Custom Scrollbar */
    #messageArea::-webkit-scrollbar {
        width: 6px;
    }

    #messageArea::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #messageArea::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    #messageArea::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    .avatar-circle {
    width: 32px;
    height: 32px;
    background-color: #e7f1ff;
    color: #0d6efd;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    }

    .avatar-circle.received {
        background-color: #f0f2f5;
        color: #1d2939;
    }

    .message-wrapper {
        max-width: calc(75% - 40px);
    }
  </style>
{% endblock %}



{% block title %}
Messages
{% endblock %}



{% block body %}


<div class="container mt-4">
    <!-- Header Section -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="d-flex align-items-center">
                <i class="fas fa-envelope me-3 text-primary"></i>
                <span class="fw-bold">Messages</span>
            </h2>
            <button class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                <i class="fas fa-plus me-2"></i>
                New Message
            </button>
        </div>
    </div>

    <!-- Search/New Message Modal -->
    <div class="modal fade" id="newMessageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="search-container position-relative mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="userSearch" 
                               placeholder="Search users...">
                        <i class="fas fa-search position-absolute end-0 top-50 translate-middle-y me-3"></i>
                    </div>
                    <div id="searchResults" class="list-group">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="row">
        <!-- Conversations List -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Conversations</h5>
                </div>
                <div class="list-group list-group-flush" id="conversationsList">
                    <!-- Conversations will be listed here -->
                </div>
            </div>
        </div>

        <!-- Active Chat Area -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0" id="activeChatHeader">Select a conversation</h5>
                </div>
                <div class="card-body" id="messageArea" style="height: 400px; overflow-y: auto;">
                    <div id="messages" class="d-flex flex-column">
                        <!-- Messages will appear here -->
                    </div>
                </div>
                <div class="card-footer">
                    <form id="messageForm" class="d-none">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control message" 
                                   placeholder="Type your message...">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    // Global variables:
    let socket;
    let activeRoom = null; // The currently active room (unique for the two users)
    let activeReceiverId = null; // The id of the user you're chatting with
    let conversations = new Map(); // We'll store conversations keyed by the room name

    // Helper: Compute room name on the client side (must match the server's logic)
    function getPrivateRoom(user1_id, user2_id) {
        // Convert to integers and sort them
        const ids = [parseInt(user1_id), parseInt(user2_id)].sort((a, b) => a - b);
        return `private_${ids[0]}_${ids[1]}`;
    }

    // Update the conversation list UI
    function updateConversationsList(data) {
        const currentUserId = '{{ user.id }}';
        const cssClass = data.sender_id == currentUserId ? 'sent' : 'received';
        const firstLetter = data.sender_name ? data.sender_name.charAt(0).toUpperCase() : '?';
        
        const messageHtml = `
            <div class="message ${cssClass} mb-3">
                <div class="d-flex align-items-start ${cssClass === 'sent' ? 'flex-row-reverse' : 'flex-row'}">
                    <div class="avatar-circle ${cssClass} me-2 ms-2">
                        ${firstLetter}
                    </div>
                    <div class="message-wrapper">
                        <div class="message-content p-2 rounded">
                            ${data.message}
                        </div>
                        <small class="text-muted d-block mt-1">
                            ${data.created_at || new Date().toLocaleTimeString()}
                        </small>
                    </div>
                </div>
            </div>
        `;
        $('#messages').append(messageHtml);
        
        // Ensure scroll to bottom
        const messageArea = document.getElementById('messageArea');
        messageArea.scrollTop = messageArea.scrollHeight;

        // Update conversation list in sidebar
        const convId = `conv_${data.room}`;
        const conversationHtml = `
            <a href="#" class="list-group-item list-group-item-action" 
               id="${convId}" 
               onclick="loadConversation('${data.room}', '${data.sender_name}')">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">
                        ${firstLetter}
                    </div>
                    <div>
                        <h6 class="mb-1">${data.sender_name}</h6>
                        <p class="mb-1 text-truncate small text-muted">${data.message}</p>
                    </div>
                </div>
            </a>
        `;

        // Update or add conversation to the list
        if (!$(`#${convId}`).length) {
            $('#conversationsList').prepend(conversationHtml);
        } else {
            $(`#${convId}`).replaceWith(conversationHtml);
        }
    }

    // Load a conversation into the active chat area
    function loadConversation(room, userName) {
        activeRoom = room;
        $('#activeChatHeader').text(userName);
        $('#messageForm').removeClass('d-none');
        $('#messages').empty();

        const conv = conversations.get(room);
        if (conv && conv.messages.length > 0) {
            conv.messages.forEach(msg => {
                appendMessage(msg);
            });
        }

        // Highlight active conversation
        $('.list-group-item').removeClass('active');
        $(`#conv_${room}`).addClass('active');

        // Enable message input
        $('.message').prop('disabled', false).focus();
    }

    // Append a message to the chat area
    function appendMessage(data) {
        const currentUserId = '{{ user.id }}';
        const cssClass = data.sender_id == currentUserId ? 'sent' : 'received';
        const firstLetter = data.sender_name.charAt(0).toUpperCase();
        
        const messageHtml = `
            <div class="message ${cssClass} mb-3">
                <div class="d-flex align-items-start ${cssClass === 'sent' ? 'flex-row-reverse' : 'flex-row'}">
                    <div class="avatar-circle ${cssClass} me-2 ms-2">
                        ${firstLetter}
                    </div>
                    <div class="message-wrapper">
                        <div class="message-content p-2 rounded">
                            ${data.message}
                        </div>
                        <small class="text-muted d-block mt-1">
                            ${formatDate(data.created_at)}
                        </small>
                    </div>
                </div>
            </div>
        `;
        $('#messages').append(messageHtml);
        scrollToBottom();
    }

    function scrollToBottom() {
        const messageArea = document.getElementById('messageArea');
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // Start a new chat from search results
    function startChat(userId, userName) {
        activeReceiverId = userId;
        // Compute room using current user's id and the selected user's id
        activeRoom = getPrivateRoom('{{ user.id }}', userId);
        console.log(activeRoom);
        $('#newMessageModal').modal('hide');
        updateConversationsList(activeRoom, userName);
        loadConversation(activeRoom, userName);
        // Emit join event to server
        socket.emit('join private', { 
            receiver_id: userId,
            room: activeRoom 
        });
    }

    // Search functionality remains similar...
    $('#userSearch').on('input', function() {
        const searchTerm = $(this).val().trim();
        if (searchTerm.length >= 2) {
            fetch(`/messages/search_users/${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">${data.error}</div>
                        `);
                        return;
                    }
                    const resultsHtml = data.users.map(([id, name]) => `
                        <button class="list-group-item list-group-item-action"
                                onclick="startChat('${id}', '${name}')">
                            ${name}
                        </button>
                    `).join('');
                    $('#searchResults').html(resultsHtml);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">Error searching users</div>
                    `);
                });
        } else {
            $('#searchResults').empty();
        }
    });

    $(document).ready(function() {
        // Initialize socket connection
        socket = io();
        
        // Handle conversations list
        socket.on('conversations_list', function(data) {
            console.log("Received conversations list:", data);
            handleConversationsList(data.conversations);
        });

        // Handle conversation data
        socket.on('conversation_data', function(data) {
            console.log("Received conversation data:", data);
            handleConversationData(data);
        });

        // Handle new messages
        socket.on('new_message', function(data) {
            console.log("Received new message:", data);
            handleNewMessage(data);
        });

        // Handle message form submission
        $('#messageForm').on('submit', function(e) {
            e.preventDefault();
            const messageInput = $(this).find('.message');
            const message = messageInput.val().trim();
            
            if (message && activeRoom) {
                const messageData = {
                    receiver_id: activeReceiverId,
                    message: message,
                    room: activeRoom
                };
                
                // Emit the message
                socket.emit('private message', messageData);
                
                // Clear input and focus
                messageInput.val('').focus();
            }
        });
    });

    function handleConversationData(data) {
        activeRoom = data.room;
        activeReceiverId = data.receiver_id;
        
        // Store conversation
        conversations.set(data.room, {
            name: data.receiver_name,
            messages: data.messages
        });
        
        // Update UI
        $('#activeChatHeader').text(data.receiver_name);
        $('#messageForm').removeClass('d-none');
        $('#messages').empty();
        
        // Display messages
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => appendMessage(msg));
        }
    }

    function handleNewMessage(data) {
        // Only update UI - no need to store messages locally
        if (activeRoom === data.room) {
            appendMessage(data);
        }
        updateSidebarConversation(data);
    }

    function updateSidebarConversation(data) {
        const currentUserId = '{{ user.id }}';
        // Determine if this is the other user in the conversation
        const isOtherUser = data.sender_id != currentUserId;
        const userName = isOtherUser ? data.sender_name : $('#activeChatHeader').text();
        const firstLetter = userName.charAt(0).toUpperCase();
        
        const convId = `conv_${data.room}`;
        const conversationHtml = `
            <a href="#" class="list-group-item list-group-item-action ${activeRoom === data.room ? 'active' : ''}" 
               id="${convId}" 
               onclick="startChat('${isOtherUser ? data.sender_id : activeReceiverId}', '${userName}')">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">
                        ${firstLetter}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1">${userName}</h6>
                            <small class="text-muted">${formatDate(data.created_at)}</small>
                        </div>
                        <p class="mb-1 text-truncate small text-muted">
                            ${data.message}
                        </p>
                    </div>
                </div>
            </a>
        `;

        // Update or add conversation to the sidebar
        if (!$(`#${convId}`).length) {
            $('#conversationsList').prepend(conversationHtml);
        } else {
            $(`#${convId}`).replaceWith(conversationHtml);
        }
    }

    function handleConversationsList(conversationsList) {
        // Clear existing conversations
        $('#conversationsList').empty();
        
        // Sort conversations by last message time
        conversationsList.sort((a, b) => 
            new Date(b.last_message_time) - new Date(a.last_message_time)
        );
        
        // Add each conversation to the sidebar
        conversationsList.forEach(conv => {
            const firstLetter = conv.other_user_name.charAt(0).toUpperCase();
            const conversationHtml = `
                <a href="#" class="list-group-item list-group-item-action" 
                   id="conv_${conv.room}" 
                   onclick="startChat('${conv.other_user_id}', '${conv.other_user_name}')">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle me-2">
                            ${firstLetter}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-1">${conv.other_user_name}</h6>
                                <small class="text-muted">${formatDate(conv.last_message_time)}</small>
                            </div>
                            <p class="mb-1 text-truncate small text-muted">
                                ${conv.last_message}
                            </p>
                        </div>
                    </div>
                </a>
            `;
            $('#conversationsList').append(conversationHtml);
            
            // Store conversation in our Map
            conversations.set(conv.room, {
                name: conv.other_user_name,
                messages: []  // Messages will be loaded when conversation is opened
            });
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        
        if (date.toDateString() === now.toDateString()) {
            // Today - show time only
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (date.getFullYear() === now.getFullYear()) {
            // This year - show month and day
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        } else {
            // Different year - show date with year
            return date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
        }
    }
</script>


{% endblock %}
<!-- end of the block body -->
{% endblock %}